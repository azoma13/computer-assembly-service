version: '3'

vars:
#version
  GO_VERSION: '1.25.3'
  OGEN_VERSION: 'v1.12.0'
  GEN_PACKAGE_ORDER: 'order_v1'
  PROTOC_VERSION: '32.0'
  PROTOC_GEN_GO_VERSION: 'v1.36.8'
  PROTOC_GEN_GO_GRPC_VERSION: 'v1.5.1'

# dir
  BIN_DIR: '{{.ROOT_DIR}}/bin'
  NODE_MODULES_DIR: '{{.ROOT_DIR}}/node_modules'
  SHARED_DIR: '{{.ROOT_DIR}}/shared'
  OPEN_API_ORDER_V1_DIR: '{{.SHARED_DIR}}/api/order/v1'
  GEN_API_ORDER_V1_DIR: '{{.SHARED_DIR}}/pkg/openapi/order/v1'
  PROTO_DIR: '{{.SHARED_DIR}}/proto'
  GEN_PROTO_V1: '{{.SHARED_DIR}}/pkg/proto'

# bin
  REDOCLY_CLI: '{{.NODE_MODULES_DIR}}/.bin/redocly'
  OGEN: '{{.BIN_DIR}}/ogen'
  PROTOC: '{{.BIN_DIR}}/protoc'
  PROTOC_GEN_GO: '{{.BIN_DIR}}/protoc-gen-go'
  PROTOC_GEN_GO_GRPC: '{{.BIN_DIR}}/protoc-gen-go-grpc'

# file
  OPEN_API_ORDER_V1_BASE: '{{.OPEN_API_ORDER_V1_DIR}}/order.v1.openapi.yaml'
  OPEN_API_ORDER_V1_BUNDLE: '{{.OPEN_API_ORDER_V1_DIR}}/bundle/order.v1.bundle.openapi.yaml'
  PROTO_HARDWARE_V1: '{{.PROTO_DIR}}/hardware/v1/hardware.proto'
  PROTO_PAYMENT_V1: '{{.PROTO_DIR}}/payment/v1/payment.proto'

tasks:
  npm:install:
    desc: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏—è npm –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    silent: true
    cmds:
      - |
        if ! command -v npm &> /dev/null; then
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm..."
          curl -fsSL https://deb.nodesource.com/setup_current.x | sudo -E bash -
          sudo apt-get install -y nodejs
          echo "‚úÖ npm —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        else
          echo "‚úÖ npm —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        fi
  
  redocly-cli:install:
    desc: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç redocly-cli
    silent: true
    deps: [ npm:install ]
    cmds:
      - |
        if [ ! -d "node_modules" ] || [ ! -f "{{.REDOCLY_CLI}}" ]; then
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ redocly-cli..."
          npm install @redocly/cli --save-dev
          echo "‚úÖ redocly-cli —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        else
          echo "‚úÖ redocly-cli —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        fi

  redocly-cli:order-v1-bundle:
    desc: –°–æ–±–∏—Ä–∞–µ—Ç OpenAPI –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª —á–µ—Ä–µ–∑ redocly-cli
    silent: true
    deps: [ redocly-cli:install ]
    cmds:
      - |
        echo "‚è≥–°–æ–±–∏—Ä–∞–µ—Ç OpenAPI –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª —á–µ—Ä–µ–∑ redocly-cli..."
        {{.REDOCLY_CLI}} bundle {{.OPEN_API_ORDER_V1_BASE}} -o {{.OPEN_API_ORDER_V1_BUNDLE}}
        echo "‚úÖ –£—Å–ø–µ—à–Ω–∞—è —Å–±–æ—Ä–∫–∞ OpenAPI –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª —á–µ—Ä–µ–∑ redocly-cli"
        
  ogen:install:
    desc: –°–∫–∞—á–∏–≤–∞–µ—Ç ogen –≤ –ø–∞–ø–∫—É bin
    silent: true
    cmds:
      - |
        if [ ! -f {{.OGEN}} ]; then
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ogen..."
          mkdir -p {{.BIN_DIR}}
          GOBIN={{.BIN_DIR}} go install github.com/ogen-go/ogen/cmd/ogen@{{.OGEN_VERSION}}
          echo "‚úÖ ogen —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        else
          echo "‚úÖ ogen —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        fi

  ogen:gen-order:
    desc: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Go-–∫–æ–¥–∞ –º–æ–¥–µ–ª–µ–π –∑–∞–∫–∞–∑–æ–≤ –∏–∑ OpenAPI-–¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏
    silent: true
    deps: [ redocly-cli:order-v1-bundle, ogen:install ]
    cmds: 
      - |
        echo "‚è≥–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –º–æ–¥–µ–ª–µ–π –∑–∞–∫–∞–∑–æ–≤ –∏–∑ OpenAPI-–¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏..."
        {{.OGEN}} -target {{.GEN_API_ORDER_V1_DIR}} --package={{.GEN_PACKAGE_ORDER}} --clean {{.OPEN_API_ORDER_V1_BUNDLE}}
        cd {{.SHARED_DIR}}
        go mod tidy
        echo "‚úÖ –£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –º–æ–¥–µ–ª–µ–π –∑–∞–∫–∞–∑–æ–≤"

  proto:install:
    desc: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç buf
    silent: true
    cmds:
      - |
        if [ ! -f {{.PROTOC}} ]; then
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ protoc..."
          mkdir -p {{.BIN_DIR}}
          sudo apt-get install unzip
          curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v{{.PROTOC_VERSION}}/protoc-{{.PROTOC_VERSION}}-linux-x86_64.zip
          unzip protoc-{{.PROTOC_VERSION}}-linux-x86_64.zip
          sudo rm -rf readme.txt protoc-{{.PROTOC_VERSION}}-linux-x86_64.zip
          cp -r include/google {{.PROTO_DIR}} && rm -R ./include
          sudo apt-get remove -y unzip
          echo "‚úÖ protoc —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        else
          echo "‚úÖ protoc —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        fi

  proto-plugins:install:
    desc: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç protoc –ø–ª–∞–≥–∏–Ω—ã
    silent: true
    deps: [ proto:install ]
    cmds:
      - |
        if [ ! -f {{.PROTOC_GEN_GO}} ]; then
          echo 'üì¶ Installing protoc-gen-go...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}}
          echo "‚úÖ protoc-gen-go —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        else
          echo "‚úÖ protoc-gen-go —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        fi
        if [ ! -f {{.PROTOC_GEN_GO_GRPC}} ]; then
          echo 'üì¶ Installing protoc-gen-go-grpc...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}}
          echo "‚úÖ protoc-gen-go-grpc —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        else
          echo "‚úÖ protoc-gen-go-grpc —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        fi
  
  proto:gen-hardware:
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–∫–∞–∑–∞
    silent: true
    deps: [ proto-plugins:install ]
    cmds:
      - |
        echo "‚è≥–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–∫–∞–∑–∞..."
        {{.PROTOC}} -I {{.PROTO_DIR}} {{.PROTO_HARDWARE_V1}} --go_out={{.GEN_PROTO_V1}} --go_opt=paths=source_relative --plugin=bin/protoc-gen-go --go-grpc_out={{.GEN_PROTO_V1}} --go-grpc_opt=paths=source_relative --plugin=bin/protoc-gen-go-grpc
        cd {{.SHARED_DIR}}
        go mod tidy
        echo "‚úÖ –£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–∫–∞–∑–∞"

  proto:gen-hardware-no-deps:
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–∫–∞–∑–∞
    silent: true
    cmds:
      - |
        echo "‚è≥–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–∫–∞–∑–∞..."
        {{.PROTOC}} -I {{.PROTO_DIR}} {{.PROTO_HARDWARE_V1}} --go_out={{.GEN_PROTO_V1}} --go_opt=paths=source_relative --plugin=bin/protoc-gen-go --go-grpc_out={{.GEN_PROTO_V1}} --go-grpc_opt=paths=source_relative --plugin=bin/protoc-gen-go-grpc
        cd {{.SHARED_DIR}}
        go mod tidy
        echo "‚úÖ –£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–∫–∞–∑–∞"

  proto:gen-payment:
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –æ–ø–ª–∞—Ç—ã
    silent: true
    deps: [ proto-plugins:install ]
    cmds:
      - |
        echo "‚è≥–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –æ–ø–ª–∞—Ç—ã..."
        {{.PROTOC}} -I {{.PROTO_DIR}} {{.PROTO_PAYMENT_V1}} --go_out={{.GEN_PROTO_V1}} --go_opt=paths=source_relative --plugin=bin/protoc-gen-go --go-grpc_out={{.GEN_PROTO_V1}} --go-grpc_opt=paths=source_relative --plugin=bin/protoc-gen-go-grpc
        cd {{.SHARED_DIR}}
        go mod tidy
        echo "‚úÖ –£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –æ–ø–ª–∞—Ç—ã"

  proto:gen-payment-no-deps:
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –æ–ø–ª–∞—Ç—ã
    silent: true
    cmds:
      - |
        echo "‚è≥–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –æ–ø–ª–∞—Ç—ã..."
        {{.PROTOC}} -I {{.PROTO_DIR}} {{.PROTO_PAYMENT_V1}} --go_out={{.GEN_PROTO_V1}} --go_opt=paths=source_relative --plugin=bin/protoc-gen-go --go-grpc_out={{.GEN_PROTO_V1}} --go-grpc_opt=paths=source_relative --plugin=bin/protoc-gen-go-grpc
        cd {{.SHARED_DIR}}
        go mod tidy
        echo "‚úÖ –£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –æ–ø–ª–∞—Ç—ã"

  proto:gen:
    desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ proto-—Ñ–∞–π–ª–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–∫–∞–∑–∞
    silent: true
    deps: [ proto-plugins:install ]
    cmds:
      - task: proto:gen-hardware-no-deps
      - task: proto:gen-payment-no-deps